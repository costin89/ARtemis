<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>USDZ with Thumbnails</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.5.0/jszip.min.js"></script>
    <style>
        #dropzone {
            width: 300px;
            height: 200px;
            border: 2px dashed gray;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
        }
        #dropzone.dragover {
            background-color: #f0f0f0;
        }
    </style>
</head>
<body>
<center>
<br><br><br>
<div id="dropzone">Drop your USDZ, Reality, and Image files here</div>
<br><br><br>    
<table id="fileTable">
    <thead>
        <tr>
            <th>#</th>
            <th>Scene File</th>
            <th>Pics</th>
        </tr>
    </thead>
    <tbody>
    </tbody>
</table>
<br><br><br>
<button id="exportBtn" disabled>Export HTML</button>
<br><br>
<p id="progress">0%</p>
</center>
<script>
    const dropzone = document.getElementById('dropzone');
    const fileTable = document.getElementById('fileTable').querySelector('tbody');
    const exportBtn = document.getElementById('exportBtn');
    const progressElement = document.getElementById('progress');

    let counter = 0;
    let usdzFiles = [];
    let imageFiles = [];

    function addRow(usdzFile, imageFiles) {
        counter++;
        const row = document.createElement('tr');

        const counterCell = document.createElement('td');
        counterCell.textContent = counter;
        row.appendChild(counterCell);

        const usdzCell = document.createElement('td');
        usdzCell.textContent = usdzFile.name + (usdzFile.isReality ? ' (reality)' : '');
        row.appendChild(usdzCell);

        const imageCell = document.createElement('td');
        const select = document.createElement('select');
        imageFiles.forEach(img => {
            const option = document.createElement('option');
            option.value = img.name;
            option.textContent = img.name;
            select.appendChild(option);
        });
        imageCell.appendChild(select);
        row.appendChild(imageCell);

        fileTable.appendChild(row);
    }

    dropzone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropzone.classList.add('dragover');
    });

    dropzone.addEventListener('dragleave', () => {
        dropzone.classList.remove('dragover');
    });

    dropzone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropzone.classList.remove('dragover');

        const currentUsdzFiles = [];
        const currentImageFiles = [];

        Array.from(e.dataTransfer.files).forEach(file => {
            const ext = file.name.split('.').pop().toLowerCase();
            switch (ext) {
                case 'usdz':
                    currentUsdzFiles.push(file);
                    usdzFiles.push(file);
                    break;
                case 'jpg':
                case 'png':
                    currentImageFiles.push(file);
                    imageFiles.push(file);
                    break;
                case 'reality':
                    currentUsdzFiles.push({ ...file, isReality: true });
                    usdzFiles.push({ ...file, isReality: true });
                    break;
                default:
                    alert(`Unsupported file type: ${ext}`);
                    break;
            }
        });

        currentUsdzFiles.forEach(usdzFile => {
            addRow(usdzFile, currentImageFiles.length > 0 ? currentImageFiles : imageFiles);
        });

        if (fileTable.querySelectorAll('tr').length > 0) {
            exportBtn.disabled = false;
        }
    });

    exportBtn.addEventListener('click', async () => {
        const zip = new JSZip();
    
        // Adding .usdz and .reality files to the zip
        usdzFiles.forEach(file => {
            if (file.isReality) {
                zip.file(file.name, file, {binary: true});
            } else {
                zip.file(file.name, file, {binary: true});
            }
        });
    
        imageFiles.forEach(file => {
            zip.file(file.name, file, {binary: true});
        });
    
        let htmlContent = `
            <!DOCTYPE html>
            <html lang="en">
            <head>
                <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>ARKit Quick Look with Thumbnails</title>
                <style>
                    .grid {
                        display: grid;
                        grid-template-columns: repeat(3, 1fr);
                        gap: 16px;
                    }
                    .grid img {
                        max-width: 100%;
                        height: auto;
                    }
                </style>
            </head>
            <body>
            <div class="grid">
        `;
    
        const rows = fileTable.querySelectorAll('tr');
        rows.forEach(row => {
            const usdzName = row.querySelector('td:nth-child(2)').textContent;
            const isReality = usdzName.includes('(reality)');
            const cleanedUsdzName = usdzName.replace(' (reality)', '');
            const imageName = row.querySelector('td:nth-child(3) select').value;
    
            htmlContent += `
                <div>
                    <a href="${cleanedUsdzName}" rel="ar">
                        <img src="${imageName}" width="250" height="250">
                    </a>
                </div>
            `;
        });
    
        htmlContent += `</div></body></html>`;
    
        // Adding the generated HTML content to the zip
        zip.file("index.html", htmlContent);
    
        const zipBlob = await zip.generateAsync({ type: "blob" }, (metadata) => {
            const progress = Math.round(metadata.percent);
            progressElement.textContent = `${progress}%`;
        });
    
        const downloadLink = document.createElement('a');
        downloadLink.href = URL.createObjectURL(zipBlob);
        downloadLink.download = 'quicklook_with_thumbnails.zip';
        document.body.appendChild(downloadLink);
        downloadLink.click();
        document.body.removeChild(downloadLink);
    });
</script>
</body>
</html>
